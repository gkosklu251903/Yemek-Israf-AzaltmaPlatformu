<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Yemek ƒ∞srafƒ±nƒ± Azaltan Platform</title>
<style>
  body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: url('https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=1470&q=80') no-repeat center center fixed;
    background-size: cover;
    color: #fff;
    height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }

  .btn-back {
    position: absolute;
    top: 30px;
    left: 30px;
    background-color: #2196F3;
    color: white;
    text-decoration: none;
    padding: 12px 28px;
    border-radius: 12px;
    font-weight: 700;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    transition: all 0.3s ease;
    border: none;
  }
  .btn-back:hover { background-color: #1976D2; transform: translateY(-2px); }

  .overlay-box {
    background: rgba(0, 0, 0, 0.6);
    padding: 40px 60px;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(5px);
  }

  h1 { font-size: 28px; font-weight: bold; margin-bottom: 15px; text-shadow: 2px 2px 5px rgba(0,0,0,0.7);}
  p { font-size: 16px; margin-bottom: 30px; text-shadow: 1px 1px 4px rgba(0,0,0,0.6);}

  .button-container {
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
  }

  button, .btn-next {
    padding: 15px 30px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    text-decoration: none;
  }

  .btn-orange {
    background-color: #ff9800;
    color: white;
    box-shadow: 0 0 10px rgba(255,152,0,0.4);
  }
  .btn-orange:hover { background-color: #e68900; transform: scale(1.05); box-shadow: 0 0 20px rgba(255,152,0,0.7); }

  .btn-gray {
    background-color: #e0e0e0;
    color: #333;
    box-shadow: 0 0 10px rgba(255,255,255,0.2);
  }
  .btn-gray:hover { background-color: #c9c9c9; transform: scale(1.05); box-shadow: 0 0 20px rgba(255,255,255,0.5); }

  .btn-green {
    background: linear-gradient(135deg, #4CAF50, #2E7D32);
    color: white;
    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
    display: none;
    width: 100%; 
    font-size: 18px;
  }
  .btn-green:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(76, 175, 80, 0.6); }

  footer { position: absolute; bottom: 20px; width: 100%; text-align: center; font-size: 14px; color: #fffbfb; }

  .spinner {
    display: none;
    width: 20px; height: 20px;
    border: 3px solid #ffffff; border-top: 3px solid transparent;
    border-radius: 50%; animation: spin 1s linear infinite;
  }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  #status-text { margin-top: 20px; font-size: 15px; font-weight: 500; display: none; }

  #manual-panel {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(8px);
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease;
    z-index: 9999;
  }
  #manual-panel .panel-box {
    background: linear-gradient(145deg, #ffffff, #f9f9f9);
    color: #222;
    padding: 40px 30px;
    border-radius: 25px;
    width: 380px;
    text-align: center;
    box-shadow: 0 15px 35px rgba(0,0,0,0.25);
    transform: scale(0.9);
    animation: panelPop 0.25s ease forwards;
    border: 2px solid rgba(76,175,80,0.2);
  }
  #manual-panel h2 {
    margin: 0 0 20px 0;
    font-size: 24px;
    font-weight: 700;
    color: #2E7D32;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
  }
  .slider-container {
    margin: 20px 0;
    text-align: left;
  }
  .slider-label {
    display: flex;
    justify-content: space-between;
    font-weight: bold;
    color: #555;
    margin-bottom: 5px;
  }
  input[type=range] {
    width: 100%;
    margin: 10px 0;
  }
  #manual-address {
    width: 100%;
    padding: 15px;
    margin-top: 15px;
    border-radius: 15px;
    border: 1px solid #ccc;
    font-size: 15px;
    outline: none;
    box-shadow: inset 0 2px 8px rgba(0,0,0,0.08);
    transition: all 0.25s ease;
  }
  #manual-address:focus {
    border-color: #4CAF50;
    box-shadow: 0 0 10px rgba(76,175,80,0.3);
  }
  #manual-confirm, #manual-cancel {
    margin-top: 20px;
    width: 100%;
    padding: 15px;
    border: none;
    border-radius: 15px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.25s ease;
  }
  #manual-confirm {
    background: linear-gradient(135deg, #4CAF50, #2E7D32);
    color: white;
    box-shadow: 0 5px 15px rgba(76,175,80,0.4);
  }
  #manual-confirm:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(76,175,80,0.6);
  }
  #manual-cancel {
    background: linear-gradient(135deg, #E53935, #B71C1C);
    color: white;
    box-shadow: 0 5px 15px rgba(217,83,79,0.4);
  }
  #manual-cancel:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(217,83,79,0.6);
  }

  #map-panel {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 10000;
    align-items: center;
    justify-content: center;
  }

  #map-container {
    background: white;
    border-radius: 15px;
    width: 90%;
    max-width: 900px;
    height: 80vh;
    display: flex;
    flex-direction: column;
  }

  #map-header {
    padding: 20px;
    background: #2E7D32;
    color: white;
    border-radius: 15px 15px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  #map-header h2 {
    margin: 0;
  }

  #close-map {
    background: red;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
  }

  #mapBox {
    flex: 1;
    position: relative;
  }

  @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
  @keyframes panelPop { from { transform: scale(0.8); opacity:0; } to { transform: scale(1); opacity:1; } }

</style>
<script>
    // Sayfa bfcache'den (back-forward cache) y√ºklendiyse sayfayƒ± yenile
    // Bu, √ßƒ±kƒ±≈ü yaptƒ±ktan sonra geri butonuna basƒ±ldƒ±ƒüƒ±nda sunucu kontrol√ºn√º zorunlu kƒ±lar
    window.addEventListener('pageshow', function (event) {
        if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
            window.location.reload();
        }
    });
</script>
</head>
<body>

  <a href="#" onclick="handleLogout()" class="btn-back" style="background-color: #ef4444;"><span>&#10006;</span> √áƒ±kƒ±≈ü Yap</a>

  <div class="overlay-box">
    
    <div id="step-1">
        <h1>Yakƒ±nƒ±nƒ±zdaki Yemekleri G√∂rmek ƒ∞ster misiniz?</h1>
        <p>Size en yakƒ±n artan yemekleri anƒ±nda listelemek i√ßin konum izninizi istiyoruz.</p>

        <div class="button-container">
          <button class="btn-orange" id="btn-share">
            <span class="spinner" id="loading-spinner"></span>
            <span>üìç Konumumu Payla≈ü (√ñnerilen)</span>
          </button>
          
          <button class="btn-gray" id="btn-manual">
            üó∫Ô∏è Konumu Manuel Gir
          </button>
        </div>
    </div>

    <div id="step-2" style="display: none;">
        <h1 style="color: #4CAF50;">Konum Ba≈üarƒ±yla Alƒ±ndƒ±! ‚úÖ</h1>
        <p>Haritada konumunuzu doƒüruladƒ±ysanƒ±z, √ßevrenizdeki lezzetli yemekleri listelemeye hazƒ±rsƒ±nƒ±z.</p>
        
        <button class="btn-next btn-green" style="display: flex;" id="listeleBtn">
            üç≤ Yemekleri Listele
            <span>&#8594;</span>
        </button>
    </div>
    
    <div id="status-text"></div>
  </div>

  <footer>¬© 2025 Yemek ƒ∞srafƒ±nƒ± Azaltan Web Platformu | Telif Hakkƒ±</footer>

  <!-- Harita Modal Panel -->
  <div id="map-panel">
    <div id="map-container">
      <div id="map-header">
        <h2>üìç Yakƒ±ndaki Yemekler</h2>
        <button id="close-map">‚úï Kapat</button>
      </div>
      <div id="mapBox"></div>
      <!-- Se√ßilen Yemeƒüi G√∂ster -->
      <div id="selected-food-panel" style="display: none; padding: 15px; background: #f0f0f0; border-top: 2px solid #ddd; color: #333;">
        <div style="text-align: center;">
          <h3 id="selected-food-name" style="margin: 0 0 10px 0; color: #2E7D32;">Se√ßilen Yemek</h3>
          <p id="selected-food-info" style="margin: 5px 0; font-size: 14px;"></p>
          <button id="go-to-food-btn" style="margin-top: 10px; padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
            üçΩÔ∏è Bu Yemeƒüe Git
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD4QccATRbpQNwfaWhbVrVesLg6kgaINco&libraries=marker"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
    const btnShare = document.getElementById('btn-share');
    const btnManual = document.getElementById('btn-manual');
    const statusText = document.getElementById('status-text');
    const spinner = document.getElementById('loading-spinner');
    
    const step1 = document.getElementById('step-1');
    const step2 = document.getElementById('step-2');

    let userLat = null;
    let userLng = null;
    let map = null;
    let foodMarkers = [];
    let selectedFood = null;

    // Haversine Form√ºl√º ile iki nokta arasƒ± mesafe hesaplama (km)
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // D√ºnya yarƒ±√ßapƒ± (km)
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        const d = R * c;
        return d;
    }

    // Yemekleri getir
    async function loadFoodsData() {
        try {
            const response = await fetch('/api/foods');
            const foods = await response.json();
            return foods;
        } catch (error) {
            console.error('Yemekler y√ºklenemedi:', error);
            return [];
        }
    }

    // Harita √ºzerinde yemekleri g√∂ster
    function displayFoodsOnMap(foods) {
        // √ñnceki markerlarƒ± kaldƒ±r
        foodMarkers.forEach(marker => marker.setMap(null));
        foodMarkers = [];

        const currentUserEmail = localStorage.getItem('currentUserEmail');
        const storageKey = currentUserEmail ? `takenFoods_${currentUserEmail}` : 'takenFoods';
        const takenFoods = JSON.parse(localStorage.getItem(storageKey) || '[]');

        foods.forEach(food => {
            // Eƒüer yemek alƒ±ndƒ±ysa haritada g√∂sterme
            if (food.status === 'alindi') return;

            // LocalStorage kontrol√º (istemci tarafƒ±nda alƒ±nanlar)
            if (food.id !== undefined && takenFoods.includes(String(food.id))) return;

            // Lokasyondan koordinatlarƒ± √ßƒ±karmayƒ± dene
            if (food.lokasyon) {
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: food.lokasyon }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const lat = results[0].geometry.location.lat();
                        const lng = results[0].geometry.location.lng();
                        
                        // Mesafe kontrol√º
                        let distance = 0;
                        let showMarker = true;
                        
                        if (userLat && userLng) {
                            distance = calculateDistance(userLat, userLng, lat, lng);
                            const maxRadius = parseFloat(localStorage.getItem('searchRadius')) || 20; // Varsayƒ±lan 20km
                            
                            if (distance > maxRadius) {
                                showMarker = false;
                            }
                        }

                        if (showMarker) {
                            // Custom marker olu≈ütur
                            const marker = new google.maps.Marker({
                                position: { lat, lng },
                                map: map,
                                title: food.name,
                                icon: {
                                    path: "M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z",
                                    fillColor: '#F44336',
                                    fillOpacity: 1,
                                    strokeColor: '#fff',
                                    strokeWeight: 2,
                                    scale: 2,
                                    anchor: new google.maps.Point(12, 22)
                                }
                            });

                            // InfoWindow ekle
                            const infoWindow = new google.maps.InfoWindow({
                                content: `
                                    <div style="color: #333; padding: 10px; font-family: Arial;">
                                        <h3 style="margin: 0 0 5px 0;">üçΩÔ∏è ${food.name}</h3>
                                        <p style="margin: 3px 0;"><strong>üìç Lokasyon:</strong> ${food.lokasyon}</p>
                                        <p style="margin: 3px 0;"><strong>üìè Mesafe:</strong> ${distance.toFixed(1)} km</p>
                                        <p style="margin: 3px 0;"><strong>‚öñÔ∏è Miktar:</strong> ${food.miktar}</p>
                                        <p style="margin: 3px 0;"><strong>‚è∞ Son T√ºketim:</strong> ${food.zaman}</p>
                                        <p style="margin: 3px 0;"><strong>üìù A√ßƒ±klama:</strong> ${food.description}</p>
                                    </div>
                                `
                            });

                            marker.addListener('click', () => {
                                selectedFood = food;
                                infoWindow.open(map, marker);
                                
                                document.getElementById('selected-food-name').textContent = food.name;
                                document.getElementById('selected-food-info').innerHTML = `
                                    <strong>üìç Lokasyon:</strong> ${food.lokasyon}<br>
                                    <strong>üìè Mesafe:</strong> ${distance.toFixed(1)} km<br>
                                    <strong>‚öñÔ∏è Miktar:</strong> ${food.miktar}<br>
                                    <strong>‚è∞ Tahmini:</strong> ${food.zaman}
                                `;
                                document.getElementById('selected-food-panel').style.display = 'block';
                            });

                            foodMarkers.push(marker);
                        }
                    }
                });
            }
        });
    }

    // Harita ba≈ülat
    function initMap(lat, lng) {
        map = new google.maps.Map(document.getElementById('mapBox'), {
            zoom: 13,
            center: { lat, lng },
            mapTypeControl: true,
            fullscreenControl: true
        });

        // Kullanƒ±cƒ± konumunu i≈üaretle
        const userMarker = new google.maps.Marker({
            position: { lat, lng },
            map: map,
            title: 'Sizin Konumunuz',
            icon: {
                path: "M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z",
                fillColor: '#2196F3',
                fillOpacity: 1,
                strokeColor: '#fff',
                strokeWeight: 2,
                scale: 2,
                anchor: new google.maps.Point(12, 22)
            }
        });

        const userInfoWindow = new google.maps.InfoWindow({
            content: '<div style="color: #333; font-weight: bold; padding: 5px;">üìç Buradasƒ±nƒ±z</div>'
        });

        userMarker.addListener('click', () => {
            userInfoWindow.open(map, userMarker);
        });

        // Yemekleri y√ºkle ve g√∂ster
        loadFoodsData().then(foods => {
            displayFoodsOnMap(foods);
        });
    }

    btnShare.addEventListener('click', () => {
        if (!navigator.geolocation) {
            alert("Tarayƒ±cƒ±nƒ±z konum servisini desteklemiyor.");
            return;
        }

        spinner.style.display = 'inline-block';
        statusText.style.display = 'block';
        statusText.textContent = "Konum alƒ±nƒ±yor...";
        statusText.style.color = "#ffd700";

        navigator.geolocation.getCurrentPosition(
            (position) => {
                userLat = position.coords.latitude;
                userLng = position.coords.longitude;

                spinner.style.display = 'none';
                statusText.style.display = 'none';
                
                // Konum localStorage'a kaydet
                localStorage.setItem('userLocation', userLat + ',' + userLng);
                localStorage.setItem('searchRadius', 20); // Varsayƒ±lan 20km
                
                // Harita panelini a√ß
                document.getElementById('map-panel').style.display = 'flex';
                initMap(userLat, userLng);

                step1.style.display = 'none';
                step2.style.display = 'block';
            },
            (error) => {
                spinner.style.display = 'none';
                statusText.style.display = 'block';
                statusText.style.color = "#ff4d4d";
                statusText.textContent = "Konum alƒ±namadƒ±. L√ºtfen manuel giri≈üi deneyin.";
            }
        );
    });

    // Harita kapanƒ±r
    document.getElementById('close-map').addEventListener('click', () => {
        document.getElementById('map-panel').style.display = 'none';
        // step-2 g√∂r√ºn√ºr kalƒ±r, "Yemekleri Listele" butonu aktif durumda
    });

    // "Bu Yemeƒüe Git" butonu - sadece se√ßili yemeƒüi g√∂ster
    const goToFoodBtn = document.getElementById('go-to-food-btn');
    console.log('go-to-food-btn element:', goToFoodBtn);
    
    if (goToFoodBtn) {
        goToFoodBtn.addEventListener('click', () => {
            console.log('Bu Yemeƒüe Git butonuna tƒ±klandƒ±');
            console.log('selectedFood:', selectedFood);
            if (selectedFood && selectedFood.id) {
                // Backend /yemek_listesi route'unu kullan (EJS render edilir)
                const url = '/yemek_listesi?foodId=' + selectedFood.id;
                console.log('Y√∂nlendiriliyorum:', url);
                window.location.href = url;
            } else {
                alert('L√ºtfen √∂nce bir yemek se√ßiniz');
            }
        });
    } else {
        console.error('go-to-food-btn element bulunamadƒ±!');
    }

    // Manuel konum paneli
    const manualPanel = document.getElementById('manual-panel');
    const manualConfirm = document.getElementById('manual-confirm');
    const manualCancel = document.getElementById('manual-cancel');
    const manualAddress = document.getElementById('manual-address');

    btnManual.addEventListener('click', () => {
        manualPanel.style.display = 'flex';
        manualAddress.focus();
    });

    manualCancel.addEventListener('click', () => {
        manualPanel.style.display = 'none';
    });

    manualConfirm.addEventListener('click', () => {
        if(manualAddress.value.trim() === ""){
            alert("L√ºtfen bir adres giriniz.");
            return;
        }

        // Girilen adresi koordinata √ßevir
        const geocoder = new google.maps.Geocoder();
        const address = manualAddress.value.trim();
        const radius = document.getElementById('radius-range').value;

        geocoder.geocode({ address: address }, (results, status) => {
            if (status === 'OK' && results[0]) {
                const lat = results[0].geometry.location.lat();
                const lng = results[0].geometry.location.lng();
                
                userLat = lat;
                userLng = lng;

                localStorage.setItem('userLocation', address);
                localStorage.setItem('searchRadius', radius);

                manualPanel.style.display = 'none';
                step1.style.display = 'none';
                step2.style.display = 'block';
                
                document.getElementById('map-panel').style.display = 'flex';
                initMap(lat, lng);
            } else {
                alert('Adres bulunamadƒ±. L√ºtfen daha a√ßƒ±k bir adres girin.');
            }
        });
    });

    // Slider deƒüi≈üimini g√∂ster
    const radiusRange = document.getElementById('radius-range');
    const radiusValue = document.getElementById('radius-value');
    if(radiusRange && radiusValue) {
        radiusRange.addEventListener('input', (e) => {
            radiusValue.textContent = e.target.value + ' km';
        });
    }

    // Yemekleri Listele butonu - t√ºm yemekleri g√∂ster
    document.getElementById('listeleBtn').addEventListener('click', () => {
        console.log('Yemekleri Listele tƒ±klandƒ±');
        
        const location = localStorage.getItem('userLocation') || '';
        console.log('userLocation:', location);
        
        // Backend /yemek_listesi route'unu kullan (foodId yok = t√ºm yemekler)
        let url = '/yemek_listesi?lokasyon=' + encodeURIComponent(location);
        
        console.log('T√ºm yemekleri listele:', url);
        window.location.href = url;
    });

    // Make handleLogout globally available
    window.handleLogout = function() {
        const btn = document.querySelector('.btn-back');
        if(btn) {
            btn.innerHTML = '<span>&#8635;</span> √áƒ±kƒ±≈ü Yapƒ±lƒ±yor...';
            btn.style.opacity = '0.7';
            btn.style.pointerEvents = 'none';
        }

        setTimeout(() => {
            localStorage.removeItem('currentUserEmail');
            localStorage.removeItem('foodClaims');
            localStorage.removeItem('notificationCount');
            localStorage.removeItem('notifications');
            localStorage.removeItem('foodReviews');
            localStorage.removeItem('userLocation');
            
            window.location.href = '/logout';
        }, 500);
    };

    }); // DOMContentLoaded kapatma
  </script>

  <!-- Manuel Konum Paneli -->
  <div id="manual-panel">
    <div class="panel-box">
      <h2>üìç Konumu Manuel Gir</h2>
      <input id="manual-address" type="text" placeholder="√ñrn: Erzurum merkez ...">
      
      <div class="slider-container">
        <div class="slider-label">
            <span>Mesafe √áapƒ±:</span>
            <span id="radius-value">20 km</span>
        </div>
        <input type="range" id="radius-range" min="1" max="50" value="20">
        <div style="font-size: 12px; color: #777;">(1 km - 50 km arasƒ±)</div>
      </div>

      <button id="manual-confirm">Onayla</button>
      <button id="manual-cancel">ƒ∞ptal</button>
    </div>
  </div>

</body>
</html>
